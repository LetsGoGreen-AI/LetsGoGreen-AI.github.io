<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
        <script src="https://docs.opencv.org/3.4/opencv.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <style>
            @font-face {
                font-family: 'Roboto';
                src: url("../Roboto-Regular.ttf");
              }
            .hover {
               position: absolute;
               z-index: 2;
               transform: translate(-50%,-50%);
            }
            h1 {
               color: black;
               font-size: 50px;
            }
            .list {
               font-size: 20px;
               margin: 2% 30%;
            }
            .btn-success {
                font-size: 20px;
                position: absolute;
                width: 175px;
                height: 50px;
                background-color:#4A5847;
                border-color: #4A5847;
            }
            .nav-item {
                font-size: 20px;
            }
            .btn-success:disabled {
                background-color:#4A5847;
                border-color: #4A5847;
            }
        </style>
    </head>
    <body style="background-color: #e5e0da; font-family:'Roboto';">
        <center>
            <nav class="navbar navbar-expand-lg bg-transparent" style="position:absolute; width:100%;z-index:4;">
                <div class="container-fluid">
                  <a style="color:#583B1F;"class="navbar-brand" href="#">LetsGoGreen.ai</a>
                  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                  </button>
                  <div class="collapse navbar-collapse justify-content-center" id="navbarNav" style="margin-right: 7%;">
                    <ul class="navbar-nav">
                      <li class="nav-item">
                        <a style="color:#583B1F;"class="nav-link" aria-current="page" href="../">Home</a>
                      </li>
                      <li class="nav-item" style="margin-left:5%;margin-right:5%;">
                        <strong>
                        <a style="color:#583B1F;"class="nav-link active" href="#">Scan</a>
                        </strong>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" style="color:#583B1F;text-wrap:nowrap;" href="../Centers/">Recycling Centers</a>
                      </li>
                    </ul>
                  </div>
                </div>
              </nav>
             <div style="background-color: #e5e0da;">
             <br>
             <br>
             <br><br>
             <h1 style="margin: 0 0; color:black; font-size: 35px;">Instructions</h1>
             <strong>
              <div style="text-align:center;">
              <ol style="text-align:left; display: inline-block;">
                <li class="list">Start the Scanner Begin by pressing "Start Scanning." It will prompt you to allow access to your camera.  Click on allow access to activate the scanner.</li>
                <li class="list">Position the Item: Hold the item you want to check in front of your device's camera. Make sure the object is well-lit and positioned in the center of the frame.</li>
                <li class="list">Take a Photo: Press "Click Photo" to take a clear photograph of the item. Try to capture as much detail as possible.</li>
                <li class="list">Image Processing: The system will tkae some time to process the image and extract the object in the foreground.</li>
                <li class="list">Display Result: Finally click "Classify Object," and within seconds, our deep</li>
              </ol>
              </div>
              <br>
              <h1 style="margin: 0 0; padding: 3%; color:black; font-size: 35px;">~ Happy Scanning! ~</h1>
             </strong>
             </div>
             <br>
             <br>
              <div id="objDetect" style="width: 100%; position: relative; height: 480;">
                  <button class="btn btn-success" style="top:25%; left: calc(50% + 340px);transform: translate(0%,-50%);" id="start-camera">Start Scanning!</button>
                  <video id="video" class="hover" style="z-index:3;top: 50%; left: 50%; " width="640" height="480" autoplay style="border: 2px solid black;"></video>
                  <button class="btn btn-success"  style="top:50%; left: calc(50% + 340px);transform: translate(0%,-50%);" disabled id="click-photo">Click Photo</button>
                  <button class="btn btn-success" style="top:75%; left: calc(50% + 340px);transform: translate(0%,-50%);" disabled id="btn">Classify Object</button>
                  <canvas id="canvas" class="hover" style="z-index:-1;top:50%; left:50%; border: 2px solid black;" width="640" height="480"></canvas>
              </div>
          <br>
              <div style="font-size: 20px;" id="label-container"></div>
              <br>
              <br>
        <canvas id="crop" width="640" height="480" style="display:none;"></canvas>
        </center>
        <script>
            var display = document.getElementById("display");
            const classes = ['an aerosol can', 'cardboard', 'clothing', 'coffee grounds', 'disposable plastic cutlery', 'eggshells', 'food waste', 'a glass container', 'a glass food jar', 'a magazine', 'a metal_can', 'a newspaper', 'office paper', 'a paper cup', 'a plastic bag', 'a plastic bottle', 'a plastic cup lid', 'a plastic detergent bottle', 'a plastic food container', 'a plastic straw', 'a shoe', 'styrofoam', 'a tea bag'];

            var model;

            async function loadModel() {
                console.log("Loading model...")
                model = await tf.loadLayersModel("model/model.json");
                console.log("Model loaded!")
            }
            loadModel();

            function preprocess(img) {
                
                let tensor = tf.browser.fromPixels(img);

                var resized = tf.image.resizeNearestNeighbor(tensor, [256,256]).toFloat()

                let offset = tf.scalar(127.5);
                return resized.sub(offset).div(offset).expandDims();
            }
            let labelContainer = document.getElementById("label-container");
            let camera_button = document.querySelector("#start-camera");
            let detect_button = document.querySelector("#btn");
            let video = document.querySelector("#video");
            let click_button = document.querySelector("#click-photo");
            let canvas = document.querySelector("#canvas");
            let ctx = canvas.getContext('2d');
            let crop = document.getElementById("crop")
            let image_data_url;

            camera_button.addEventListener('click', async function() {
                let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video.srcObject = stream;
                canvas.style["z-index"] = -1;
                click_button.disabled = false;
                camera_button.disabled = true;
            });

            click_button.addEventListener('click', function() {
                if (click_button.innerHTML != "Clear") {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.style["z-index"] = 4;
                    image_data_url = new Image();
                    click_button.innerHTML = "Processing...";
                    setTimeout(function(){
                        let src = cv.imread('canvas');
                        cv.cvtColor(src, src, cv.COLOR_RGBA2RGB, 0);
                        let mask = new cv.Mat();
                        let bgdModel = new cv.Mat();
                        let fgdModel = new cv.Mat();
                        let rect = new cv.Rect(100, 50, 440, 380);
                        cv.grabCut(src, mask, rect, bgdModel, fgdModel, 1, cv.GC_INIT_WITH_RECT);
                        // draw foreground
                        for (let i = 0; i < src.rows; i++) {
                            for (let j = 0; j < src.cols; j++) {
                                if (mask.ucharPtr(i, j)[0] == 0 || mask.ucharPtr(i, j)[0] == 2) {
                                    src.ucharPtr(i, j)[0] = 255;
                                    src.ucharPtr(i, j)[1] = 255;
                                    src.ucharPtr(i, j)[2] = 255;
                                }
                            }
                        }
                        cv.imshow('crop', src);
                        image_data_url.src = crop.toDataURL("image");
                        src.delete(); mask.delete(); bgdModel.delete(); fgdModel.delete();
                        detect_button.disabled = false;
                        click_button.innerHTML = "Clear";
                    }, 0);
                    // data url of the image
                } else {
                    canvas.style["z-index"] = -1;
                    click_button.innerHTML = "Click Photo";
                    detect_button.disabled = true;
                }
            });

            async function predict() {
                console.log("Preprocessing image...");
                var f = preprocess(image_data_url);
                console.log("Predicting...");
                var pred = await model.predict(f).data();
                console.log("Done!");
                labelContainer.innerHTML = "This looks like " + classes[tf.argMax(pred).dataSync()[0]] + ".";
            }

            detect_button.addEventListener('click',predict);
        </script>
    </body>
</html>